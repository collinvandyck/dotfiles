#!/usr/bin/env bash
set -euo pipefail

# lc == limactl helper

KEY=~/.ssh/lima

bail() { echo "$@" >&2; exit 1; }

usage() {
	cat <<-EOF
	usage: $(basename "$0") <command> [args]

	commands:
	EOF
	local fmt="  %-28s %s\n"
	printf "$fmt" "list, ls" "list vms"
	printf "$fmt" "create <name> [-f,--force]" "create a vm"
	printf "$fmt" "delete [name]" "delete a vm"
	printf "$fmt" "stop [name]" "stop a vm"
	printf "$fmt" "<inst> [cmds...]" "run shell commands on an instance"
	exit 1
}

cmd_create() {
	inst="${1:?instance required}"; shift;
	force="${1:-}"; shift;
	if limactl list "$inst" &>/dev/null; then
		[[ -z "$force" ]] && bail "$inst vm already exists. use --force to recreate"
		limactl delete "$inst" -f
	fi
	if [[ ! -f "$KEY" ]]; then
		echo "Creating SSH key: $KEY"
		ssh-keygen -f "$KEY" -N ''
	fi
	limactl create --name "$inst" \
		template:default \
		--set '.user.name = "collin"'  \
		--set '.user.home = "/home/collin"' \
		--yes
	limactl start "$inst" --mount-none
	limactl copy "$KEY" "$inst":/home/collin/.ssh/id_ed25519
	limactl copy "$KEY".pub "$inst":/home/collin/.ssh/id_ed25519.pub
	limactl shell "$inst" sh -c 'if ! test -e ~/.dotfiles; then cd ~ && GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=accept-new" git clone git@github.com:collinvandyck/dotfiles.git ~/.dotfiles; fi'
	limactl shell "$inst" sh -c 'cd ~/.dotfiles && git pull && ./install-all'
	limactl restart "$inst"
	limactl shell "$inst"
}

cmd="${1:-}"
shift || usage

case "$cmd" in
	list|ls)
		limactl list
		;;
	create)
		inst="${1:?inst required as first param}"; shift;
		force=""
		while [[ $# -gt 0 ]]; do
			case "$1" in
				--force|-f) force=1; shift ;;
				-*) bail "unknown flag: $1" ;;
				*) bail "unexpected argument: $1" ;;
			esac
		done
		cmd_create "$inst" "$force"
		;;
	stop)
		inst="${1:?inst required as first param}"; shift;
		limactl stop "$inst"
		;;
	delete)
		inst="${1:?inst required as first param}"; shift;
		force=""
		while [[ $# -gt 0 ]]; do
			case "$1" in
				--force|-f) force="--force"; shift ;;
				-*) bail "unknown flag: $1" ;;
				*) bail "unexpected argument: $1" ;;
			esac
		done
		limactl delete "$inst" ${force:+"$force"}
		;;
	*)
		inst="$cmd"
		limactl shell "$inst" "$@"
esac
exit
